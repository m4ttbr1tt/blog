<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Kubernetes The Hard Way - Workers, kubectl and Network routes | Software Engineering &amp; DevOps - Matt Britt</title>
<link rel="icon" href="favicon.svg" sizes="any" type="image/svg+xml" /><meta property="og:url" content="http://localhost:1313/posts/kubernetes-the-hard-way-workers-kubectl-network-routes/">
  <meta property="og:site_name" content="Software Engineering & DevOps - Matt Britt">
  <meta property="og:title" content="Kubernetes The Hard Way - Workers, kubectl and Network routes">
  <meta property="og:description" content="The final part of this series is to get the workers running and to configure connections to the cluster via kubectl.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-07-29T19:51:31+02:00">
    <meta property="article:modified_time" content="2025-07-29T19:51:31+02:00">
    <meta property="article:tag" content="K8S">
      <meta property="og:see_also" content="http://localhost:1313/posts/kubernetes-the-hard-way-encryption-etcd-and-controllers/">
      <meta property="og:see_also" content="http://localhost:1313/posts/kubernetes-the-hard-way-resources-certs-and-config/">
      <meta property="og:see_also" content="http://localhost:1313/posts/kubernetes-the-hard-way-prep-with-ansible/">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Kubernetes The Hard Way - Workers, kubectl and Network routes">
  <meta name="twitter:description" content="The final part of this series is to get the workers running and to configure connections to the cluster via kubectl.">

    <link rel="stylesheet" href="/css/root.css">
    <link rel="stylesheet" href="/css/bundle.css">

      <script src="/js/bundle.js"></script><script defer src="/js/search/flexsearch.compact.64594b125f7b78bdf4fa8316955922bbebb1cd6baef3f16654bfca20309f18f8.js" integrity="sha256-ZFlLEl97eL30&#43;oMWlVkiu&#43;uxzWuu8/FmVL/KIDCfGPg="></script>
<script defer src="/js/search/search.1d980f84df11f3eb7c8c5f17f541d49a0611608df179dd74fa7f06225eb56ace.js" integrity="sha256-HZgPhN8R8&#43;t8jF8X9UHUmgYRYI3xed10&#43;n8GIl61as4="></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />


</head>
<body class="notransition">
  <div id="container">
    <header id="main-header"><div role="navigation" aria-label="Main">
  <div class="nav-left">
    <a href="http://localhost:1313/" style="color: inherit;">Matt Britt</a>
  </div>
  <div class="nav-right">
    <div style="position:absolute;width:0px;height:0px;">
      <div id="nav-dropdown-menu" class="hidden" href="#">
    <div class="nav-item">
      <a href="/posts/"
      >Blog</a>
    </div>
    <div class="nav-item">
      <a href="/about/"
      >About</a>
    </div>
</div>
    </div>
    <a id="nav-dropdown-button" href="#"><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
    <div id="nav-menu">
    <div class="nav-item">
      <a href="/posts/"
      >Blog</a>
    </div>
    <div class="nav-item">
      <a href="/about/"
      >About</a>
    </div>
</div>
    <a id="theme-switcher" href="#">
<svg class="light-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 3V4M12 20V21M4 12H3M6.31412 6.31412L5.5 5.5M17.6859 6.31412L18.5 5.5M6.31412 17.69L5.5 18.5001M17.6859 17.69L18.5 18.5001M21 12H20M16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>

<svg class="dark-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M3.32031 11.6835C3.32031 16.6541 7.34975 20.6835 12.3203 20.6835C16.1075 20.6835 19.3483 18.3443 20.6768 15.032C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834C12.3497 15.6834 8.32031 11.654 8.32031 6.68342C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996C5.65605 4.66028 3.32031 7.89912 3.32031 11.6835Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
  </div>
</div>
</header>
    <div class="flex grow">
      <div id="main-pane">
        <main id="main-content"><div class="single-header">
<ol class="breadcrumbs" itemscope itemtype="https://schema.org/BreadcrumbList">
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="http://localhost:1313/">
        <span itemprop="name">Home</span>
      </a>
      <meta itemprop="position" content='1' />
    </li>
    <span>&nbsp»&nbsp</span>
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="http://localhost:1313/posts/">
        <span itemprop="name">Posts</span>
      </a>
      <meta itemprop="position" content='2' />
    </li>
    <span>&nbsp»&nbsp</span>
</ol>
<h1>Kubernetes The Hard Way - Workers, kubectl and Network routes</h1><time class="dim" datetime="2025-07-29T19:51:31&#43;02:00">July 29, 2025</time><div class="term-container"><div class="tag">
        <a href="http://localhost:1313/tags/k8s/">#K8S</a>
      </div></ol></div>
  <section class="page-section"><p>The final part of this series is to get the workers running and to configure connections to the cluster via kubectl.</p>
<p>Full notes and scripts are available on my <a href="https://github.com/m4ttbr1tt/lab/tree/main/kubernetesthehardway">GitHub</a></p>
<h3 id="worker-bootstrapping">Worker bootstrapping</h3>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Copy the Kubernetes binaries and systemd unit files to each worker instance:</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">for</span> HOST in node-0 node-1; <span style="color:#ff7b72">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#79c0ff">SUBNET</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#ff7b72">$(</span>grep <span style="color:#a5d6ff">${</span><span style="color:#79c0ff">HOST</span><span style="color:#a5d6ff">}</span> machines.txt | cut -d <span style="color:#a5d6ff">&#34; &#34;</span> -f 4<span style="color:#ff7b72">)</span>
</span></span><span style="display:flex;"><span>  sed <span style="color:#a5d6ff">&#34;s|SUBNET|</span><span style="color:#79c0ff">$SUBNET</span><span style="color:#a5d6ff">|g&#34;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    configs/10-bridge.conf &gt; 10-bridge.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  sed <span style="color:#a5d6ff">&#34;s|SUBNET|</span><span style="color:#79c0ff">$SUBNET</span><span style="color:#a5d6ff">|g&#34;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    configs/kubelet-config.yaml &gt; kubelet-config.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  scp 10-bridge.conf kubelet-config.yaml <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  root@<span style="color:#a5d6ff">${</span><span style="color:#79c0ff">HOST</span><span style="color:#a5d6ff">}</span>:~/
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">for</span> HOST in node-0 node-1; <span style="color:#ff7b72">do</span>
</span></span><span style="display:flex;"><span>  scp <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    downloads/worker/* <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    downloads/client/kubectl <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    configs/99-loopback.conf <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    configs/containerd-config.toml <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    configs/kube-proxy-config.yaml <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    units/containerd.service <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    units/kubelet.service <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    units/kube-proxy.service <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    root@<span style="color:#a5d6ff">${</span><span style="color:#79c0ff">HOST</span><span style="color:#a5d6ff">}</span>:~/
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">for</span> HOST in node-0 node-1; <span style="color:#ff7b72">do</span>
</span></span><span style="display:flex;"><span>  scp <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    downloads/cni-plugins/* <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    root@<span style="color:#a5d6ff">${</span><span style="color:#79c0ff">HOST</span><span style="color:#a5d6ff">}</span>:~/cni-plugins/
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># on node-0 and node-1</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  apt-get update
</span></span><span style="display:flex;"><span>  apt-get -y install socat conntrack ipset kmod
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>swapon --show
</span></span><span style="display:flex;"><span>swapoff -a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Create the installation directories:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  /etc/cni/net.d <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  /opt/cni/bin <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  /var/lib/kubelet <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  /var/lib/kube-proxy <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  /var/lib/kubernetes <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  /var/run/kubernetes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Install the worker binaries:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  mv crictl kube-proxy kubelet runc <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    /usr/local/bin/
</span></span><span style="display:flex;"><span>  mv containerd containerd-shim-runc-v2 containerd-stress /bin/
</span></span><span style="display:flex;"><span>  mv cni-plugins/* /opt/cni/bin/
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Create the bridge network configuration file:</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mv 10-bridge.conf 99-loopback.conf /etc/cni/net.d/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># To ensure network traffic crossing the CNI bridge network is processed by iptables, </span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># load and configure the br-netfilter kernel module:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  modprobe br-netfilter
</span></span><span style="display:flex;"><span>  echo <span style="color:#a5d6ff">&#34;br-netfilter&#34;</span> &gt;&gt; /etc/modules-load.d/modules.conf
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#a5d6ff">&#34;net.bridge.bridge-nf-call-iptables = 1&#34;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    &gt;&gt; /etc/sysctl.d/kubernetes.conf
</span></span><span style="display:flex;"><span>  echo <span style="color:#a5d6ff">&#34;net.bridge.bridge-nf-call-ip6tables = 1&#34;</span> <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    &gt;&gt; /etc/sysctl.d/kubernetes.conf
</span></span><span style="display:flex;"><span>  sysctl -p /etc/sysctl.d/kubernetes.conf
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Configure containerd</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Install the containerd configuration files:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  mkdir -p /etc/containerd/
</span></span><span style="display:flex;"><span>  mv containerd-config.toml /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>  mv containerd.service /etc/systemd/system/
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Configure the Kubelet</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Create the kubelet-config.yaml configuration file:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  mv kubelet-config.yaml /var/lib/kubelet/
</span></span><span style="display:flex;"><span>  mv kubelet.service /etc/systemd/system/
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">#Configure the Kubernetes Proxy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  mv kube-proxy-config.yaml /var/lib/kube-proxy/
</span></span><span style="display:flex;"><span>  mv kube-proxy.service /etc/systemd/system/
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Start the Worker Services</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  systemctl daemon-reload
</span></span><span style="display:flex;"><span>  systemctl enable containerd kubelet kube-proxy
</span></span><span style="display:flex;"><span>  systemctl start containerd kubelet kube-proxy
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl is-active kubelet
</span></span></code></pre></div><h3 id="configure-kubectl">Configure kubectl</h3>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  kubectl config set-cluster kubernetes-the-hard-way <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    --certificate-authority<span style="color:#ff7b72;font-weight:bold">=</span>ca.crt <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    --embed-certs<span style="color:#ff7b72;font-weight:bold">=</span>true <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    --server<span style="color:#ff7b72;font-weight:bold">=</span>https://server.kubernetes.local:6443
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  kubectl config set-credentials admin <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    --client-certificate<span style="color:#ff7b72;font-weight:bold">=</span>admin.crt <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    --client-key<span style="color:#ff7b72;font-weight:bold">=</span>admin.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  kubectl config set-context kubernetes-the-hard-way <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    --cluster<span style="color:#ff7b72;font-weight:bold">=</span>kubernetes-the-hard-way <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    --user<span style="color:#ff7b72;font-weight:bold">=</span>admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  kubectl config use-context kubernetes-the-hard-way
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="pod-network-routes">Pod network routes</h3>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#79c0ff">SERVER_IP</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#ff7b72">$(</span>grep server machines.txt | cut -d <span style="color:#a5d6ff">&#34; &#34;</span> -f 1<span style="color:#ff7b72">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#79c0ff">NODE_0_IP</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#ff7b72">$(</span>grep node-0 machines.txt | cut -d <span style="color:#a5d6ff">&#34; &#34;</span> -f 1<span style="color:#ff7b72">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#79c0ff">NODE_0_SUBNET</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#ff7b72">$(</span>grep node-0 machines.txt | cut -d <span style="color:#a5d6ff">&#34; &#34;</span> -f 4<span style="color:#ff7b72">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#79c0ff">NODE_1_IP</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#ff7b72">$(</span>grep node-1 machines.txt | cut -d <span style="color:#a5d6ff">&#34; &#34;</span> -f 1<span style="color:#ff7b72">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#79c0ff">NODE_1_SUBNET</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#ff7b72">$(</span>grep node-1 machines.txt | cut -d <span style="color:#a5d6ff">&#34; &#34;</span> -f 4<span style="color:#ff7b72">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh root@server <span style="color:#a5d6ff">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">  ip route add ${NODE_0_SUBNET} via ${NODE_0_IP}
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">  ip route add ${NODE_1_SUBNET} via ${NODE_1_IP}
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh root@node-0 <span style="color:#a5d6ff">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">  ip route add ${NODE_1_SUBNET} via ${NODE_1_IP}
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh root@node-1 <span style="color:#a5d6ff">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">  ip route add ${NODE_0_SUBNET} via ${NODE_0_IP}
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">EOF</span>
</span></span></code></pre></div><h3 id="final-tests">Final tests</h3>
<p>We are ready to test the cluster, verifying that we can create a secret, deployment and service.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Create a generic secret:</span>
</span></span><span style="display:flex;"><span>kubectl create secret generic kubernetes-the-hard-way <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  --from-literal<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;mykey=mydata&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh root@server <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>    <span style="color:#a5d6ff">&#39;etcdctl get /registry/secrets/default/kubernetes-the-hard-way | hexdump -C&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Create a deployment for the nginx web server:</span>
</span></span><span style="display:flex;"><span>kubectl create deployment nginx <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  --image<span style="color:#ff7b72;font-weight:bold">=</span>nginx:latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># List the pod created by the nginx deployment:</span>
</span></span><span style="display:flex;"><span>kubectl get pods -l <span style="color:#79c0ff">app</span><span style="color:#ff7b72;font-weight:bold">=</span>nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Retrieve the full name of the nginx pod:</span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff">POD_NAME</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#ff7b72">$(</span>kubectl get pods -l <span style="color:#79c0ff">app</span><span style="color:#ff7b72;font-weight:bold">=</span>nginx <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  -o <span style="color:#79c0ff">jsonpath</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;{.items[0].metadata.name}&#34;</span><span style="color:#ff7b72">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Forward port 8080 on your local machine to port 80 of the nginx pod:</span>
</span></span><span style="display:flex;"><span>kubectl port-forward <span style="color:#79c0ff">$POD_NAME</span> 8080:80
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl --head http://127.0.0.1:8080
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># exec commands in container</span>
</span></span><span style="display:flex;"><span>kubectl exec -ti <span style="color:#79c0ff">$POD_NAME</span> -- nginx -v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Expose the nginx deployment using a NodePort service:</span>
</span></span><span style="display:flex;"><span>kubectl expose deployment nginx <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  --port <span style="color:#a5d6ff">80</span> --type NodePort
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Retrieve the node port assigned to the nginx service:</span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff">NODE_PORT</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#ff7b72">$(</span>kubectl get svc nginx <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  --output<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">jsonpath</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#39;{range .spec.ports[0]}{.nodePort}&#39;</span><span style="color:#ff7b72">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># Retrieve the hostname of the node running the nginx pod:</span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff">NODE_NAME</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#ff7b72">$(</span>kubectl get pods <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  -l <span style="color:#79c0ff">app</span><span style="color:#ff7b72;font-weight:bold">=</span>nginx <span style="color:#79c0ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#79c0ff"></span>  -o <span style="color:#79c0ff">jsonpath</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;{.items[0].spec.nodeName}&#34;</span><span style="color:#ff7b72">)</span>
</span></span></code></pre></div><h3 id="final-thoughts">Final thoughts</h3>
<p>Working through this series has given valuable insight into the underlying workings of Kubernetes. The scripts to get this running are so well written and documented that it was relatively easy to get it running.
The value of working through this comes from further digging into what is being setup and how it works. Always be curious!</p>
<p>Now that I&rsquo;ve got the cluster running&hellip; I&rsquo;m going to delete it 🤣 - and install a TalosOS cluster.</p></section></main>
        <footer id="main-footer"><div class="footer">
  <a href="#">Scroll to Top</a>
  <div class="footer-copyright">
    <div class="dim">© 2025 Matt Britt</div>
  </div>
</div>
</footer>
      </div><aside id="side-pane" class=""><div class="side-details">
    <span>691 words</span>
    <span>5 - 6 minutes read</span><div class="side-details-taxonomy">
        <small>authors: 
          <span class="details-taxonomy"><a href="http://localhost:1313/authors/matt-britt">Matt Britt</a></span></small>
      </div><div class="side-details-taxonomy">
        <small>series: 
          <span class="details-taxonomy"><a href="http://localhost:1313/series/kubernetes-the-hard-way">Kubernetes The Hard Way</a></span></small>
      </div></div><h3>Table Of Contents</h3><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#worker-bootstrapping">Worker bootstrapping</a></li>
        <li><a href="#configure-kubectl">Configure kubectl</a></li>
        <li><a href="#pod-network-routes">Pod network routes</a></li>
        <li><a href="#final-tests">Final tests</a></li>
        <li><a href="#final-thoughts">Final thoughts</a></li>
      </ul>
    </li>
  </ul>
</nav><h3>Related</h3>
    <ul><li><a href="/posts/kubernetes-the-hard-way-encryption-etcd-and-controllers/">Kubernetes The Hard Way - Encryption, Etcd and Controllers</a></li><li><a href="/posts/kubernetes-the-hard-way-resources-certs-and-config/">Kubernetes The Hard Way - Resources, Certs and Config</a></li><li><a href="/posts/kubernetes-the-hard-way-prep-with-ansible/">Kubernetes The Hard Way - Preparing machines with Ansible</a></li></ul></aside></div>
  </div>
</body>
</html>
